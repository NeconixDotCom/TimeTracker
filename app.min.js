var TimeTrackerApp=function(){function e(){this.updateTimerInterval=1e3,this.updateTimerTime=0;var e=this.getRepoUuid(),t=this.getRepoPath();this.dataModel=this.getDataModel(e,t);var r=this;this.dataModel.retrieveUserFromServer(function(){r.dataModel.retrieveIssuesFromServer(),AJS.$("#time-tracker-timer-select").on("change",function(e){r.onTimerSelectChanged(e)}),r.startUpdateTimer()})}return e.prototype.getRepoUuid=function(){var e=location.search,t=e.match(/^\?uuid=([^&]*)&path=([^&]*)/),r=t[1];return AP.require("_util",function(e){r=e.decodeQueryComponent(r)}),r},e.prototype.getRepoPath=function(){var e=location.search,t=e.match(/^\?uuid=([^&]*)&path=([^&]*)/),r=t[2];return AP.require("_util",function(e){r=e.decodeQueryComponent(r)}),r},e.prototype.getDataModel=function(e,t){var r="TimeTracker-"+e,o=window.localStorage.getItem(r),i=JSON.parse(o),n=new TimeTrackerDataModel;this.dataModel=n,null==i?n.model.repoUuid=e:n.model=i,n.model.repoPath=t,n.save();var s=this;return n.issuesUpdated=function(){s.issuesUpdatedCallback()},n.workItemsUpdated=function(){s.workItemsUpdatedCallback()},n.currentWorkItemUpdated=function(){s.currentWorkItemUpdatedCallback()},n.sessionTimeUpdated=function(){s.sessionTimeUpdatedCallback()},n},e.prototype.issuesUpdatedCallback=function(){this.updateTimerSelect(),this.updateRecentWorkItemsTable()},e.prototype.workItemsUpdatedCallback=function(){this.updateTimerSelect(),this.updateRecentWorkItemsTable()},e.prototype.currentWorkItemUpdatedCallback=function(){this.updateRecentWorkItemsTable(),this.updateTimerCounters()},e.prototype.sessionTimeUpdatedCallback=function(){this.updateTimerSessionTime()},e.prototype.updateTimerSelect=function(){var e=this.dataModel.getIssuesCollection(),t='<option value="none">None</option>';t+='<optgroup label="Recent">',e.recent.forEach(function(e){var r=e.id,o="#"+e.id+": "+e.title;t+='<option value="'+r+'">'+o+"</option>"}),t+="</optgroup>",t+='<optgroup label="Assigned to me">',e.assignedToMe.forEach(function(e){var r=e.id,o="#"+e.id+": "+e.title;t+='<option value="'+r+'">'+o+"</option>"}),t+="</optgroup>",t+='<optgroup label="Other">',e.other.forEach(function(e){var r=e.id,o="#"+e.id+": "+e.title;t+='<option value="'+r+'">'+o+"</option>"}),t+="</optgroup>",AJS.$("#time-tracker-timer-select").html(t),AJS.$("#time-tracker-timer-select").prop("disabled",!1);var r=this.dataModel.currentWorkItem;null!=r?AJS.$("#time-tracker-timer-select").val(r.issueId).trigger("change"):AJS.$("#time-tracker-timer-select").val("none").trigger("change")},e.prototype.updateTimerCounters=function(){var e=this.dataModel.currentWorkItem;if(null!=e){AJS.$("#timer-tracker-timer-counter-container").show();var t=TimeTrackerUtilities.getFriendlyTimeFromMilliseconds(e.timeLogged);AJS.$("#timer-tracker-timer-counter-total-time").html(t)}else AJS.$("#timer-tracker-timer-counter-container").hide()},e.prototype.updateTimerSessionTime=function(){var e=TimeTrackerUtilities.getFriendlyTimeFromMilliseconds(this.dataModel.sessionTime);AJS.$("#timer-tracker-timer-counter-session-time").html(e)},e.prototype.updateRecentWorkItemsTable=function(){var e=this;AJS.$("#time-tracker-recent-table-footer").hide();var t=this.dataModel.model.workItems.slice();if(0==t.length)AJS.$("#time-tracker-recent-table-body").html(""),AJS.$("#time-tracker-recent-table-footer-message").html("No recent work items to display"),AJS.$("#time-tracker-recent-table-footer").show();else{var r="",o=this;t.forEach(function(t){var i=o.dataModel.getIssue(t.issueId);if(null!=i){var n="#"+i.id+": "+i.title,s="//bitbucket.org/"+e.dataModel.model.repoPath+"/issues/"+i.id,a=TimeTrackerUtilities.getFriendlyTimeFromMilliseconds(t.timeLogged),u=TimeTrackerUtilities.getFriendlyDateFromDate(t.lastActivity);r+='<tr><td><a href="'+s+'" target="_top">'+n+"</a></td><td>"+a+"</td><td>"+u+'</td><td><button class="aui-button time-tracker-log-button" id="'+i.id+'"><span class="aui-icon aui-icon-small aui-iconfont-edit">Log</span><span> Log</span></button><button class="aui-button time-tracker-delete-button" id="'+i.id+'"><span class="aui-icon aui-icon-small aui-iconfont-delete">Delete</span><span> Delete</span></button></td></tr>'}}),AJS.$("#time-tracker-recent-table-body").html(r),AJS.$(".time-tracker-log-button").on("click",function(e){var t=parseInt(this.id,10);o.logAndDeleteWorkItem(t)}),AJS.$(".time-tracker-delete-button").on("click",function(e){var t=parseInt(this.id,10);o.deleteWorkItem(t)})}},e.prototype.onTimerSelectChanged=function(e){if(null!=e.added&&null!=e.added.id){var t=e.added.id;if("none"==t)this.dataModel.clearCurrentWorkItem();else{var r=parseInt(t,10);this.dataModel.setCurrentWorkItemWithIssue(r)}}},e.prototype.startUpdateTimer=function(){var e=this;this.updateTimerTime=Date.now(),this.updateTimerId=setInterval(function(){e.onTimerInterval()},this.updateTimerInterval)},e.prototype.onTimerInterval=function(){var e=Date.now(),t=e-this.updateTimerTime;this.updateTimerTime=e,this.dataModel.addTimeLoggedToSessionTime(t);var r=this.dataModel.addTimeLoggedToCurrentWorkItem(t);r||this.updateRecentWorkItemsTable()},e.prototype.logAndDeleteWorkItem=function(e){var t=e;AJS.dialog2("#time-tracker-log-dialog").show(),AJS.$("#time-tracker-log-dialog-ok-button").off("click");var r=this;AJS.$("#time-tracker-log-dialog-ok-button").on("click",function(e){r.dataModel.logAndDeleteWorkItemForIssue(t),AJS.dialog2("#time-tracker-log-dialog").hide()})},e.prototype.deleteWorkItem=function(e){var t=e;AJS.dialog2("#time-tracker-delete-dialog").show(),AJS.$("#time-tracker-delete-dialog-ok-button").off("click");var r=this;AJS.$("#time-tracker-delete-dialog-ok-button").on("click",function(e){r.dataModel.deleteWorkItemForIssue(t),AJS.dialog2("#time-tracker-delete-dialog").hide()})},e}(),TimeTrackerDataModel=function(){function e(){this.model=new TimeTrackerInternalDataModel,this.issues=[],this.username=null,this.currentWorkItem=null,this.sessionTime=0}return e.prototype.save=function(){var e="TimeTracker-"+this.model.repoUuid,t=JSON.stringify(this.model);window.localStorage.setItem(e,t)},e.prototype.retrieveUserFromServer=function(e){var t=this;AP.require("request",function(r){r({url:"/1.0/user",success:function(r){null!=r.user&&r.user.username&&(t.username=r.user.username),e()},error:function(){AJS.flag({type:"error",title:"Error",close:"auto",body:"Failed to get current user"})}})})},e.prototype.retrieveIssuesFromServer=function(){var e=this.model.repoPath,t=this;AP.require("request",function(r){r({url:"/1.0/repositories/"+e+"/issues",success:function(e){var r=e.issues;null!=r&&(t.issues=[],r.forEach(function(e){var r=new TimeTrackerIssue;r.id=e.local_id,r.title=e.title,r.assignee=null,null!=e.responsible&&null!=e.responsible.username&&(r.assignee=e.responsible.username),t.issues.push(r)})),t.notifyIssuesUpdated()},error:function(){AJS.flag({type:"error",title:"Error",close:"auto",body:"Failed to get issues for current repository"})}})})},e.prototype.notifyIssuesUpdated=function(){null!=this.issuesUpdated&&this.issuesUpdated()},e.prototype.getIssue=function(e){for(var t=0;t<this.issues.length;t++){var r=this.issues[t];if(r.id==e)return r}return null},e.prototype.getIssuesCollection=function(){var e=new TimeTrackerIssueCollection,t=this;return e.recent=[],this.model.workItems.forEach(function(r){var o=t.getIssue(r.issueId);null!=o&&e.recent.push(o)}),e.assignedToMe=[],e.other=[],this.issues.forEach(function(r){var o=t.getWorkItemForIssue(r.id);null==o&&(null!=r.assignee&&r.assignee==t.username?e.assignedToMe.push(r):e.other.push(r))}),e},e.prototype.getWorkItemForIssue=function(e){for(var t=0;t<this.model.workItems.length;t++){var r=this.model.workItems[t];if(r.issueId==e)return r}return null},e.prototype.createWorkItemForIssue=function(e,t){var r=new TimeTrackerWorkItem;return r.issueId=e,this.model.workItems.push(r),this.save(),t&&this.notifyWorkItemsUpdated(),r},e.prototype.logAndDeleteWorkItemForIssue=function(e){null!=this.currentWorkItem&&this.currentWorkItem.issueId==e&&this.clearCurrentWorkItem();var t=null,r=this.model.workItems.splice(0),o=[];r.forEach(function(r){r.issueId!=e?o.push(r):t=r}),this.model.workItems=o,this.save(),this.notifyWorkItemsUpdated(),this.logWorkItemAsComment(t)},e.prototype.logWorkItemAsComment=function(e){var t=TimeTrackerUtilities.getFriendlyTimeFromMilliseconds(e.timeLogged),r="Logged "+t+" of work",o="content="+encodeURIComponent(r);console.log(o);var i="/1.0/repositories/"+this.model.repoPath+"/issues/"+e.issueId+"/comments";console.log(i);var n=this;AP.require("request",function(r){r({url:i,type:"POST",data:o,contentType:"application/x-www-form-urlencoded",success:function(r){var o="//bitbucket.org/"+n.model.repoPath+"/issues/"+e.issueId,i="Logged "+t+" of work on Issue #"+e.issueId,s='<ul class="aui-nav-actions-list"><li><a href="'+o+'" target="_top">View issue</a></li></ul>';AJS.flag({type:"success",title:i,close:"auto",body:s})},error:function(){AJS.flag({type:"error",title:"Error",close:"auto",body:"Failed to log time worked on Issue #"+e.issueId})}})})},e.prototype.deleteWorkItemForIssue=function(e){null!=this.currentWorkItem&&this.currentWorkItem.issueId==e&&this.clearCurrentWorkItem();var t=this.model.workItems.splice(0),r=[];t.forEach(function(t){t.issueId!=e&&r.push(t)}),this.model.workItems=r,this.save(),this.notifyWorkItemsUpdated()},e.prototype.sortWorkItems=function(){this.model.workItems.sort(function(e,t){return e.lastActivity>t.lastActivity?-1:e.lastActivity<t.lastActivity?1:0}),this.save()},e.prototype.notifyWorkItemsUpdated=function(){null!=this.workItemsUpdated&&this.workItemsUpdated()},e.prototype.setCurrentWorkItemWithIssue=function(e){var t=this.getWorkItemForIssue(e);null==t&&(t=this.createWorkItemForIssue(e,!1)),t.lastActivity=Date.now(),this.currentWorkItem=t,this.sortWorkItems(),this.notifyWorkItemsUpdated(),this.notifyCurrentWorkItemUpdated(),this.sessionTime=0,this.notifySessionTimeUpdated()},e.prototype.clearCurrentWorkItem=function(){this.currentWorkItem=null,this.notifyCurrentWorkItemUpdated(),this.sessionTime=0,this.notifySessionTimeUpdated()},e.prototype.addTimeLoggedToCurrentWorkItem=function(e){var t=this.currentWorkItem;if(null!=t){var r=t.timeLogged;return t.timeLogged=r+e,t.lastActivity=Date.now(),this.save(),this.notifyCurrentWorkItemUpdated(),!0}return!1},e.prototype.notifyCurrentWorkItemUpdated=function(){null!=this.currentWorkItemUpdated&&this.currentWorkItemUpdated()},e.prototype.addTimeLoggedToSessionTime=function(e){this.sessionTime+=e,this.notifySessionTimeUpdated()},e.prototype.notifySessionTimeUpdated=function(){null!=this.sessionTimeUpdated&&this.sessionTimeUpdated()},e}(),TimeTrackerInternalDataModel=function(){function e(){this.repoUuid=null,this.repoPath=null,this.workItems=[]}return e}(),TimeTrackerWorkItem=function(){function e(){this.issueId=0,this.timeLogged=0,this.lastActivity=0}return e}(),TimeTrackerIssue=function(){function e(){}return e}(),TimeTrackerIssueCollection=function(){function e(){}return e}(),TimeTrackerStopwatch=function(){function e(){this.running=!1,this.startTime=0,this.endTime=0,this.totalTime=0}return e.prototype.start=function(){var e=Date.now();this.startTime=e,this.endTime=e,this.totalTime=0,this.running=!0},e.prototype.stop=function(){this.running&&(this.endTime=Date.now(),this.totalTime=this.endTime-this.startTime,this.running=!1)},e.prototype.getElapsedTimed=function(){if(this.running){var e=Date.now();return e-this.startTime}return this.totalTime},e}(),TimeTrackerUtilities=function(){function e(){}return e.getFriendlyTimeFromMilliseconds=function(e){if(6e4>e)return"< 1m";var t=Math.floor(e/6e4),r=Math.floor(t/60);t-=60*r;var o="";return r>0&&(o+=r+"h"),t>0&&(o+=""==o?t+"m":" "+t+"m"),o},e.getFriendlyDateFromDate=function(e){var t=new Date(e),r=new Date;return this.getFriendlyDateFromDateAndToday(t,r)},e.getFriendlyDateFromDateAndToday=function(e,t){var r=t.getTime()-e.getTime(),o=Math.round(r/1e3);if(45>o)return"just now";if(3569>o){var i=Math.round(o/60);return 1>=i?"1 minute ago":i+" minutes ago"}if(84599>o){var n=Math.round(o/3600);return 1>=n?"1 hour ago":n+" hours ago"}if(2548799>o){var s=Math.round(o/86400);return 1>=s?"1 day ago":s+" days ago"}if(29807999>o){var a=Math.round(o/2592e3);return 1>=a?"1 month ago":a+" months ago"}var u=Math.round(o/31104e3);return 1>=u?"1 year ago":u+" years ago"},e}();AJS.$("#time-tracker-timer-select").auiSelect2(),AJS.$("#time-tracker-delete-dialog-cancel-button").on("click",function(e){e.preventDefault(),AJS.dialog2("#time-tracker-delete-dialog").hide()}),AJS.$("#time-tracker-log-dialog-cancel-button").on("click",function(e){e.preventDefault(),AJS.dialog2("#time-tracker-log-dialog").hide()});var timeTrackerApp=new TimeTrackerApp;